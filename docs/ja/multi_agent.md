---
search:
  exclude: true
---
# 複数エージェントのオーケストレーション

オーケストレーションとは、アプリ内でのエージェントのフローを指します。どのエージェントを実行するか、その順序はどうするか、そして次に何をするかをどのように決定するか、ということです。エージェントをオーケストレーションする主な方法は 2 つあります。

1.  LLM に意思決定させる方法: LLM の知性を活用して計画・推論し、それに基づいて次のステップを決定します。  
2.  コードでオーケストレーションする方法: コードによってエージェントのフローを決定します。

これらのパターンは組み合わせて使用できます。それぞれに以下のようなトレードオフがあります。

## LLM によるオーケストレーション

エージェントとは、instructions、ツール、ハンドオフを備えた LLM です。つまり、オープンエンドなタスクが与えられた場合でも、LLM はタスクをどのように進めるかを自律的に計画し、ツールを使ってアクションを実行してデータを取得し、ハンドオフを使ってサブエージェントにタスクを委譲できます。たとえば、リサーチエージェントには次のようなツールを装備できます。

- Web 検索でオンライン情報を取得  
- ファイル検索と取得でプロプライエタリデータや接続先を検索  
- コンピュータ操作でコンピュータ上のアクションを実行  
- コード実行でデータ分析を行う  
- 計画立案やレポート作成などが得意な専門エージェントへのハンドオフ  

タスクがオープンエンドで LLM の知性に依存したい場合、このパターンは非常に有効です。ここで重要な戦術は次のとおりです。

1. 良いプロンプトに投資する。利用可能なツール、それらの使い方、および操作すべきパラメーターを明確にします。  
2. アプリをモニタリングし、改善を重ねる。問題が発生する箇所を確認し、プロンプトを改良します。  
3. エージェント自身に内省と改善をさせる。たとえばループで実行し、自己批判させたり、エラーメッセージを渡して修正させたりします。  
4. 何でもこなす汎用エージェントより、1 つのタスクに特化したエージェントを用意します。  
5. [evals](https://platform.openai.com/docs/guides/evals) に投資する。これによりエージェントを訓練し、タスク遂行能力を向上させられます。  

## コードによるオーケストレーション

LLM によるオーケストレーションは強力ですが、コードによるオーケストレーションは速度、コスト、パフォーマンスの観点でより決定論的かつ予測可能にできます。代表的なパターンは次のとおりです。

- [structured outputs](https://platform.openai.com/docs/guides/structured-outputs) を使い、コードで検査できる適切な形式のデータを生成する。たとえば、エージェントにタスクをいくつかのカテゴリーに分類させ、そのカテゴリーに応じて次のエージェントを選択する、といった使い方です。  
- あるエージェントの出力を次のエージェントの入力へ変換して、複数のエージェントをチェーンする。ブログ記事を書くタスクを「リサーチ → アウトライン作成 → 記事執筆 → 批評 → 改善」という一連のステップに分解するなどが可能です。  
- `while` ループでタスクを実行するエージェントと、出力を評価してフィードバックを返すエージェントを組み合わせ、評価者が特定の基準を満たしたと判断するまで繰り返します。  
- 依存関係のない複数タスクを高速化するために、たとえば Python の基本コンポーネントである `asyncio.gather` などを使って複数エージェントを並列実行します。  

[`examples/agent_patterns`](https://github.com/openai/openai-agents-python/tree/main/examples/agent_patterns) に code examples を多数用意しています。