---
search:
  exclude: true
---
# 複数エージェントのオーケストレーション

オーケストレーションとは、アプリ内でエージェントがどのように流れるかを指します。どのエージェントをどの順番で実行し、次に何をすべきかをどのように決定するかということです。エージェントをオーケストレーションする主な方法は 2 つあります。

1. LLM に意思決定させる: LLM の知能を利用して計画・推論を行い、その結果に基づいて次のステップを決定します。  
2. コードでオーケストレーションする: コードによってエージェントの流れを決定します。

これらのパターンは組み合わせて使うことも可能です。それぞれメリットとデメリットがあり、以下で説明します。

## LLM によるオーケストレーション

エージェントとは、LLM に instructions、tools、handoffs を装備させたものです。これにより、オープンエンドなタスクが与えられた場合でも、LLM はタスクをどうこなすかを自律的に計画し、tools を使ってアクションやデータ取得を行い、handoffs でサブエージェントにタスクを委任できます。たとえば、リサーチエージェントには次のようなツールを持たせることができます:

- Web 検索でオンライン情報を取得  
- ファイル検索と取得で独自データや接続を検索  
- コンピュータ操作で PC 上の操作を実行  
- コード実行でデータ分析を実施  
- 計画立案やレポート作成に特化したエージェントへのハンドオフ  

このパターンはタスクがオープンエンドで、LLM の知能に依存したい場合に有効です。ここで重要な戦術は次のとおりです。

1. 良いプロンプトに投資する。利用可能なツール、その使い方、守るべきパラメーターを明確にします。  
2. アプリをモニタリングして反復する。問題が起きた箇所を確認し、プロンプトを改善します。  
3. エージェントに内省と改善を許可する。たとえばループで実行して自己批評させたり、エラーメッセージを与えて改善させるなどです。  
4. 1 つのタスクに特化したエージェントを用意し、何でもこなせる汎用エージェントに期待しすぎないようにします。  
5. [evals](https://platform.openai.com/docs/guides/evals) に投資する。これによりエージェントを学習させ、タスク遂行能力を向上できます。  

## コードによるオーケストレーション

LLM によるオーケストレーションは強力ですが、コードでオーケストレーションすることで、速度・コスト・パフォーマンスの面でより決定論的かつ予測可能になります。主なパターンは以下のとおりです。

- [structured outputs](https://platform.openai.com/docs/guides/structured-outputs) を使用して、コードで検査できる適切な形式のデータを生成します。たとえば、エージェントにタスクをいくつかのカテゴリーに分類させ、そのカテゴリーに基づいて次のエージェントを選択できます。  
- あるエージェントの出力を変換して次のエージェントの入力とすることで、複数のエージェントをチェーンします。ブログ記事の作成であれば、リサーチ → アウトライン作成 → 本文作成 → 批評 → 改善という一連のステップに分解できます。  
- タスクを実行するエージェントを `while` ループで回し、評価とフィードバックを行うエージェントを併走させ、評価者が基準を満たしたと判断するまで繰り返します。  
- `asyncio.gather` などの Python の基本コンポーネントを使って複数エージェントを並列実行します。互いに依存しない複数タスクがある場合、速度向上に役立ちます。  

[`examples/agent_patterns`](https://github.com/openai/openai-agents-python/tree/main/examples/agent_patterns) には多数のコード例があります。